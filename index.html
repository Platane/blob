<html>
<title>bloby blob</title>
<body style="margin:0">


</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stats.js/r11/Stats.min.js"></script>
<script src="intervalle.js"></script>
<script>


var sticks = [
    {
        cx: 0.5,
        blob:[
            { tau: 0.045, cy: 0.3, l:0.2 },
            { tau: 0.045, cy: 0.2, l:0 },
            //{ tau: 0.04, cy: 0.8, l:0 },
            //{ tau: 0.04, cy: 0.6, l:0 },
        ]
    }
]


var gauss = function( cx, cy, tau, x, y ){

    var xx = cx - x
    var yy = cy - y

    var d = ( xx*xx + yy*yy ) / ( tau * tau )

    return Math.exp( -0.5 * d  )
}




var canvas = document.createElement( 'canvas' )
document.body.appendChild( canvas )
var ctx = canvas.getContext( '2d' )
var draw = function(  ){



    var w = canvas.width = 400
    var h = canvas.height = 400

    ctx.clearRect( 0, 0, w, h )
    ctx.fillStyle = '#000000'

    for(var k = sticks.length; k-- ;){

        var cx = sticks[ k ].cx * w

        var blob = sticks[ k ].blob

        // draw black body zone
        var int = new Interval()

        blob.forEach( function( b ){
            if ( b.l > 0 )
                int.union( b.cy - b.l, b.cy + b.l )
        })

        int.i.forEach( function( b ){
            ctx.beginPath()
            ctx.rect( cx-20, b.min*h, 40 , (b.max-b.min)*h )
            ctx.fill()
        })

        // draw non overlaping circle
        blob.reduce( function( p, b ){

            p.push( { cy: b.cy - b.l, tau: b.tau } )

            p.push( { cy: b.cy + b.l, tau: b.tau } )

            return p
        }, [] )
        .forEach( function( b ) {
            ctx.beginPath()
            ctx.arc( cx, b.cy*h, 20 , 0, Math.PI*2 )
            ctx.fill()
        })

        // draw gauss skin
        var ext = {
            bottom : blob.map( function( b ){
                return {
                    cy: b.cy - b.l,
                    tau: b.tau,
                    int: new Interval().add( b.cy-b.l-0.142, b.cy-b.l )
                }
            }),
            top : blob.map( function( b ){
                return {
                    cy: b.cy + b.l,
                    tau: b.tau,
                    int: new Interval().add( b.cy+b.l, b.cy+b.l+0.142 )
                }
            })
        }

        for( var u = ext.top.length; u--; )
        for( var v = ext.bottom.length; v--; )
        {

            var h = ext.top[ u ].int.clone().intersection( ext.bottom[ v ].int )

            if( !h.isEmpty() ){


                var cg = [ ext.top[ u ], ext.bottom[ v ] ]


                var x1 = cx-20
                var x2 = cx+20
                var y1 = 0|(h.i[0].min*400)
                var y2 = 0|(h.i[0].max*400)

                if( y1 == y2 )
                    continue


                ctx.beginPath()
                ctx.rect( x1, y1, x2-x1, y2-y1 )
                ctx.fillStyle = '#211371'
                ctx.fill()




                for( var x = x1; x< x2; x++ )
                for( var y = y1; y< y2; y++ )
                {
                    var sum = cg.reduce( function( sum, g ){
                        return sum + gauss( cx/400, g.cy, g.tau, x/400, y/400 )
                    }, 0 )

                    var e = 1-Math.min(1, sum )

                    e = e > 0.48 ? 1 : 0

                    var color = ( 0| (e * 255 ) ).toString( 16 )
                    if( color.length < 2 )
                        color = '0'+color

                    ctx.beginPath()
                    ctx.rect( x, y, 1, 1 )
                    ctx.fillStyle = '#'+color+color+color
                    ctx.fill()

                }




            }
        }

    }
}



var t = 0
cycle = function(){

    t++

    //sticks[ 0 ].blob[ 0 ].l = Math.sin( t * 0.01 ) * 0.06 + 0.1
    //sticks[ 0 ].blob[ 0 ].cy = Math.sin( t * 0.07 ) * 0.1 + 0.5

    sticks[ 0 ].blob[ 1 ].cy = Math.sin( t * 0.05 ) * 0.2 + 0.6


    draw()

    window.requestAnimationFrame( cycle )
}
cycle()

document.body.addEventListener( 'mousemove', function( event ){
    sticks[ 0 ].blob[ 1 ].cy = event.pageY / 400
})

</script>
</html>
