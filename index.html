<html>
<title>bloby blob</title>
<body style="margin:0">


</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stats.js/r11/Stats.min.js"></script>
<script>

var stickRadius = 0.051
var tau = 0.056
var sticks = [
    {
        color: '#126392',
        cx: 0.5,
        blob:[
            { cy: 0.3, l:0.1 },
            { cy: 0.5, l:0.023 },
        ]
    },
    {
        color: '#486ed1',
        cx: 0.35,
        blob:[
            { cy: 0.6, l:0.03 },
            { cy: 0.5, l:0.02 },
        ]
    },
    {
        color: '#4ed153',
        cx: 0.65,
        blob:[
            { cy: 0.4, l:0.03 },
            { cy: 0.5, l:0.01 },
        ]
    }
]

var computeThreshold = function( stickRadius, tau ){
    return gauss( 0, 0, tau, 0, stickRadius )
}
var computeActiveZone = function( stickRadius, tau, epsylon ){
    return Math.sqrt( - 2 * Math.log( epsylon ) * tau*tau ) + stickRadius
}


var gauss = function( cx, cy, tau, x, y ){

    var xx = cx - x
    var yy = cy - y

    var d = ( xx*xx + yy*yy ) / ( tau * tau )

    return Math.exp( -0.5 * d  )
}

/**
 * draw one blob
 */
var drawOneBlob = function( ctx, dim, cx, cy, l, stickRadius ){
    ctx.beginPath()
    ctx.arc( cx*dim.x, (cy-l)*dim.y+1, stickRadius*dim.y, Math.PI, 0 )
    ctx.fill()
    ctx.beginPath()
    ctx.rect( cx*dim.x-stickRadius*dim.x, (cy-l)*dim.y, stickRadius*2*dim.x, l*2*dim.y)
    ctx.fill()
    ctx.beginPath()
    ctx.arc( cx*dim.x, (cy+l)*dim.y-1, stickRadius*dim.y, 0, Math.PI )
    ctx.fill()
}


/**
 * draw all the blobs of the stick
 */
var drawBodyStick = function( ctx, dim, stick, stickRadius ){
    ctx.fillStyle = stick.color

    for( var i = stick.blob.length; i--; )
        drawOneBlob( ctx, dim, stick.cx, stick.blob[ i ].cy, stick.blob[ i ].l, stickRadius )
}


var drawJonction = function( ctx, dim, ox, oy, width, height, gaussOrigins, tau, color, threshold ){

    var left = ( 0 | ( ox * dim.x ) )+1
    var right = ( 0 | ( ( ox + width ) * dim.x ) )-1
    var top = 0 | ( oy * dim.y )
    var bot = 0 | ( ( oy + height ) * dim.y )

    ctx.fillStyle = color

    //return

    for( var x=left; x<=right; x++ )
    for( var y=top; y<=bot; y++ )
    {
        var sum = 0

        for( var k=gaussOrigins.length; k--; )
            sum += gauss( ox+width/2, gaussOrigins[ k ], tau, x/dim.x, y/dim.y )

        if( sum < threshold )
            continue

        ctx.globalAlpha = Math.min(1 , ( sum - threshold ) * 80 )

        ctx.beginPath()
        ctx.rect( x, y, 1, 1 )
        ctx.fill()
    }

    // TODO use symetry
}

/**
 * draw all the jonctions between the blobs of the stick
 */
var drawBlobyJonction = function( ctx, dim, stick, stickRadius, tau ){

    var azone = computeActiveZone( stickRadius, tau, 0.005 )

    var blobs = stick.blob

    var threshold = computeThreshold( stickRadius, tau )

    var bot, top

    for( var i = blobs.length; i--; )
    for( var j = blobs.length; j--; )
    {

        if(  i != j && ( bot = blobs[ i ].cy - blobs[ i ].l ) - ( top = blobs[ j ].cy + blobs[ j ].l ) < azone && bot - top > 0 ){

            // contact
            drawJonction( ctx, dim, stick.cx-stickRadius, top, stickRadius*2, bot-top, [ bot, top ], tau, stick.color, threshold )
        }

    }

}

var drawStick = function( ctx, dim, stick, stickRadius, tau ){

    drawBlobyJonction( ctx, dim, stick, stickRadius, tau )

    drawBodyStick( ctx, dim, stick, stickRadius )

}


var canvas = document.createElement( 'canvas' )
document.body.appendChild( canvas )
var ctx = canvas.getContext( '2d' )
var draw = function(  ){



    var w = canvas.width = 200
    var h = canvas.height = 200

    ctx.clearRect( 0, 0, w, h )
    ctx.fillStyle = '#000000'

    for(var k = sticks.length; k-- ;)

        drawStick( ctx, {x:w, y:h}, sticks[ k ], stickRadius , tau )


}


var stats = {
    begin: function(){},
    end: function(){},
}
var t = 0
cycle = function(){

    t++

    sticks[ 0 ].blob[ 0 ].l = Math.sin( t * 0.01 ) * 0.06 + 0.1
    sticks[ 0 ].blob[ 0 ].cy = Math.sin( t * 0.07 ) * 0.1 + 0.5

    sticks[ 2 ].blob[ 0 ].cy = Math.sin( t * 0.05 ) * 0.15 + 0.7

    stats.begin()
    draw()
    stats.end()

    window.requestAnimationFrame( cycle )
}
cycle()

document.body.addEventListener( 'mousemove', function( event ){

    var x = event.pageX / window.innerWidth
    var y = event.pageY / window.innerHeight

    sticks[ 0 ].blob[ 1 ].cy = 0.1 + x*0.8
    sticks[ 1 ].blob[ 1 ].cy = 0.9 - x*0.6
    sticks[ 2 ].blob[ 1 ].cy = 0.2 + x*0.8
})


window.onload = function(){

    if( window.Stats ){
        stats = new Stats()

        stats.domElement.style.position = 'absolute'
        stats.domElement.style.right = '0px'
        stats.domElement.style.bottom = '0px'

        document.body.appendChild( stats.domElement )
    }
}

</script>
</html>
